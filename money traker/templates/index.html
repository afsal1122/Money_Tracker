{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
    <!-- Summary Section -->
    <div class="summary-grid">
        <article class="card">
            <div class="summary-card-content">
                <div class="icon lent"><i class="fa-solid fa-arrow-down"></i></div>
                <div>
                    <h4>Kittan (You are Owed)</h4>
                    <h2 class="lent">₹{{ "%.2f"|format(total_owed) }}</h2>
                </div>
            </div>
        </article>
        <article class="card">
            <div class="summary-card-content">
                <div class="icon borrowed"><i class="fa-solid fa-arrow-up"></i></div>
                <div>
                    <h4>Kodkkan (You Owe)</h4>
                    <h2 class="borrowed">₹{{ "%.2f"|format(total_owe) }}</h2>
                </div>
            </div>
        </article>
    </div>

    <!-- Forms Section -->
    <div class="forms-grid">
        <article class="card">
            <h3><i class="fa-solid fa-plus-circle"></i> Add Transaction</h3>
            <form action="{{ url_for('add_transaction') }}" method="POST">
                <!-- Form fields are the same -->
                <label for="person_id">Aarkku?</label>
                <select id="person_id" name="person_id" required>
                    <option value="" disabled selected>Select a person</option>
                    {% for person in people %}<option value="{{ person.id }}">{{ person.name }}</option>{% endfor %}
                </select>
                <label for="direction">Direction</label>
                <select id="direction" name="direction" required>
                    <option value="lent">Njan Koduthu (I Lent)</option>
                    <option value="borrowed">Njan Vaangi (I Borrowed)</option>
                </select>
                <label for="amount">Amount (₹)</label>
                <input type="number" id="amount" name="amount" step="0.01" placeholder="e.g., 500" required>
                <label for="description">Vivaram</label>
                <input type="text" id="description" name="description" placeholder="e.g., Chayakku" required>
                <button type="submit">Add Transaction</button>
            </form>
        </article>
        <article class="card">
            <h3><i class="fa-solid fa-user-plus"></i> Add New Person</h3>
            <form action="{{ url_for('add_person') }}" method="POST">
                <label for="person_name">Friend's Name</label>
                <input type="text" id="person_name" name="person_name" placeholder="e.g., Ramesh" required>
                <button type="submit">Add Person</button>
            </form>
        </article>
    </div>
    
    <hr>
    
    <h2>Active Debts</h2>
    {% if debts %}
        {% for debt in debts %}
        <article class="card debt-item">
            <div class="debt-item-main">
                <div class="debt-info">
                    <h4>
                        {% if debt.direction == 'lent' %}
                            <span class="lent">{{ debt.person.name }} Tharanam</span>
                        {% else %}
                            <span class="borrowed">Njan Kodukkanam {{ debt.person.name }}</span>
                        {% endif %}
                    </h4>
                    <small>Balance</small>
                </div>
                <div class="debt-balance">
                    <strong>₹{{ "%.2f"|format(debt.balance) }}</strong>
                </div>
            </div>
            <div class="debt-actions">
                <form action="{{ url_for('make_payment', debt_id=debt.id) }}" method="POST" class="payment-form">
                    <input type="number" name="payment_amount" step="0.01" max="{{ debt.balance }}" placeholder="Pay Amount" required>
                    <button type="submit" class="secondary outline">Pay</button>
                </form>
                <a href="{{ url_for('settle_debt', debt_id=debt.id) }}" role="button" class="contrast">Settle Full</a>
            </div>
            
            <details>
                <summary>History</summary>
                <ul class="transaction-list">
                    {% for t in debt.transactions|sort(attribute='date', reverse=True) %}
                    <li>
                        <div>
                            <span>
                                {% if t.type == 'payment' %}
                                    <i class="fa-solid fa-hand-holding-dollar lent"></i> Payment Made
                                {% else %}
                                    <i class="fa-solid fa-money-bill-transfer borrowed"></i> Loan
                                {% endif %}
                            </span>:
                            {{ t.description }}
                            <br><small class="trans-date">{{ t.date.strftime('%d-%b-%Y') }}</small>
                        </div>
                        <strong class="transaction-amount {{ 'lent' if t.type == 'payment' else 'borrowed' }}">
                            {{ '-' if t.type == 'payment' else '+' }}₹{{ "%.2f"|format(t.amount) }}
                        </strong>
                    </li>
                    {% endfor %}
                </ul>
            </details>
        </article>
        {% endfor %}
    {% else %}
        <article class="card"><p>No active debts. All settled up!</p></article>
    {% endif %}
{% endblock %}